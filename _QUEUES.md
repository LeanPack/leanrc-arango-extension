# ArangoDB Queues

## Some issues here

Не всё так безоблачно в мире ArangoDB. По крайней мере, в версии 3.0. Примерно
месяц назад была найдена проблема [с обработкой исключений в задачах (jobs)](https://github.com/arangodb/arangodb/issues/2042).

На 10.10.2016 пока проблема не решена. Поэтому для того, чтобы задача корректно
освобождала воркер, надо, чтобы все исключения были перехвачены.

К сожалению, это приводит к тому, что все задачи завершаются статусом `complete`,
даже если внутри был вызван `job.abort()` (он, правда, вписывает в список ошибок
факт того, что был вызван).

Поразмышляв по поводу проблемы внутри ArangoDB, было решено написать враппер,
которые обеспечит хотя бы ограниченный функционал работы с очередью. Проверено
на ArangoDB Server 3.0.10. На версии 3.0.5 *НЕ РАБОТАЕТ* (ошибка с `Job::abort`)!

Пример использования враппера:

```coffee
assert = require 'assert'
ArangoExtension = require 'leanrc-arango-extension'

require '../index'

ArangoExtension::Utils.runJob
  command: (params, jobId) ->
    console.log 'Test Failure params', JSON.stringify params
    console.log 'Test Failure jobId:', jobId

    assert.equal 2, 1, 'A failure'
  failure: (err, params, job) ->
    console.log 'Error:', err.message  if err?
    return
  context: module.context
  retryOnFailure: yes

module.exports = 'great'
```

Функция врпппера принимает в качестве аргумента объект с опциями:

`command` (_обязательное_): оборачиваемое тело задачи, в которой может
возникнуть исключение. Если исключение имело место, оно пробрасывается на
уровень скрипта;

`failure` (_необязательное_): обработчик возникшей ошибки. Исключения внутри
него подавляются и никуда далее не передаются (UPDATE: исключения выводятся в лог);

`context` (_обязательное_): передаваемый в обёртку контекст модуля скрипта,
из которого извлекаются параметры запуска и идентификатор задачи;

`retryOnFailure` (_необязательное_): указывает, ставить ли задачу в очередь
повторное, если было исключение. Управление количеством повторов из стандартных
настроек задачи для очереди. По умолчанию `false`.
